<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Lingkun&#39;s Small House">
<meta property="og:url" content="https://ohyoukillkenny.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Lingkun&#39;s Small House">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lingkun&#39;s Small House">






  <link rel="canonical" href="https://ohyoukillkenny.github.io/blog/page/2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Lingkun's Small House</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lingkun's Small House</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Youth is not a time of life, it is a state of mind.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/blog/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/blog/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ohyoukillkenny.github.io/blog/blog/2018/02/06/DNA-min-mismatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lingkun Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lingkun's Small House">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/02/06/DNA-min-mismatch/" itemprop="url">
                  Needleman–Wunsch algorithm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-06T10:47:55+08:00">2018-02-06</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>The <strong>Needleman–Wunsch algorithm</strong> is an <a href="https://en.wikipedia.org/wiki/Algorithm" target="_blank" rel="noopener">algorithm</a> used in <a href="https://en.wikipedia.org/wiki/Bioinformatics" target="_blank" rel="noopener">bioinformatics</a> to <a href="https://en.wikipedia.org/wiki/Sequence_alignment" target="_blank" rel="noopener">align</a> <a href="https://en.wikipedia.org/wiki/Protein" target="_blank" rel="noopener">protein</a> or <a href="https://en.wikipedia.org/wiki/Nucleotide" target="_blank" rel="noopener">nucleotide</a> sequences. It was one of the first applications of <a href="https://en.wikipedia.org/wiki/Dynamic_programming" target="_blank" rel="noopener">dynamic programming</a> to compare biological sequences.</p>
<p>In this article, we try to use Needleman-Wunsch algorithm to  find the minimum mismatch between two different DNA sequences.</p>
<h4 id="Definition-of-Mismatches"><a href="#Definition-of-Mismatches" class="headerlink" title="Definition of Mismatches"></a>Definition of Mismatches</h4><p>Here we have two different DNA sequences, i.e., <code>S1</code> and <code>S2</code>, where</p>
<p><code>S1 = &quot;GCATGCU&quot;</code>,</p>
<p><code>S2 = &quot;GCTTAGCU&quot;</code>.</p>
<p>One solution to match these two DNA sequences is listed as below:</p>
<p><code>S1* = &quot;GCAT-GCU&quot;</code>,</p>
<p><code>S2* = &quot;GCTTAGCU&quot;</code>,</p>
<p>in which <code>-</code> is called as “gap”, i.e., in this position the DNA is supposed to be unknown.</p>
<p><strong>Match</strong>: The two letters are the same, except both two letters are gapped.</p>
<p><strong>Mismatch</strong>: The two letters are differential or both two letters are gapped.</p>
<p>By above definition, the solution we find for matching <code>S1</code> and <code>S2</code> has two mismatches — <code>T</code> &amp; <code>A</code> and <code>-</code> &amp; <code>A</code>.</p>
<h4 id="Codes-for-finding-minimum-mismatches"><a href="#Codes-for-finding-minimum-mismatches" class="headerlink" title="Codes for finding minimum mismatches"></a>Codes for finding minimum mismatches</h4><p>Here I list the python code for finding minimum number of mismatches between two DNA sequences. The insights of codes below can be viewed by supplemental documents <a href="./insights.pdf">here</a>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">input:</span></span><br><span class="line"><span class="string">    S1 = ['A','B','C','D']</span></span><br><span class="line"><span class="string">    S2 = ['A','B','C']</span></span><br><span class="line"><span class="string">output:</span></span><br><span class="line"><span class="string">    1</span></span><br><span class="line"><span class="string">print info:</span></span><br><span class="line"><span class="string">    New S1 is:   ABCD</span></span><br><span class="line"><span class="string">    New S2 is:   ABC-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MinMismatch</span><span class="params">(S1, S2)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    First of all, we construct matrix for counting maximum length of common subsequence.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    l1, l2 = len(S1), len(S2)</span><br><span class="line">    matrix = [[<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> range(l2+<span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> range(l1+<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, l1+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>, l2+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> S1[i<span class="number">-1</span>] == S2[j<span class="number">-1</span>]:</span><br><span class="line">                matrix[i][j] = matrix[i<span class="number">-1</span>][j<span class="number">-1</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                matrix[i][j] = max(matrix[i<span class="number">-1</span>][j<span class="number">-1</span>], matrix[i][j<span class="number">-1</span>], matrix[i<span class="number">-1</span>][j])</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Dynamic programming. Tracing back the matrix and construct two DNA sequences with gaps.</span></span><br><span class="line"><span class="string">    We saved the restructured sequences into A (originally S1) and B (originally S2).</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    left_up, up, left = <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">    i, j = l1, l2</span><br><span class="line">    A, B = [], []</span><br><span class="line">    <span class="keyword">while</span> (i,j) != (<span class="number">0</span>,<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            i, j = i, j<span class="number">-1</span></span><br><span class="line">            flag = left</span><br><span class="line">        <span class="keyword">elif</span> j == <span class="number">0</span>:</span><br><span class="line">            i, j = i<span class="number">-1</span>, j</span><br><span class="line">            flag = up</span><br><span class="line">        <span class="keyword">elif</span> S1[i<span class="number">-1</span>] == S2[j<span class="number">-1</span>] <span class="keyword">or</span> matrix[i<span class="number">-1</span>][j<span class="number">-1</span>] == max(matrix[i<span class="number">-1</span>][j<span class="number">-1</span>], matrix[i][j<span class="number">-1</span>], matrix[i<span class="number">-1</span>][j]):</span><br><span class="line">            i, j, flag = i<span class="number">-1</span>, j<span class="number">-1</span>, left_up</span><br><span class="line">        <span class="keyword">elif</span> matrix[i<span class="number">-1</span>][j] == max(matrix[i<span class="number">-1</span>][j<span class="number">-1</span>], matrix[i][j<span class="number">-1</span>], matrix[i<span class="number">-1</span>][j]):</span><br><span class="line">            i, j, flag = i<span class="number">-1</span>, j, up</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            i, j, flag = i, j<span class="number">-1</span>, left</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> flag == left_up:</span><br><span class="line">            A.append(S1[i])</span><br><span class="line">            B.append(S2[j])</span><br><span class="line">        <span class="keyword">elif</span> flag == up:</span><br><span class="line">            A.append(S1[i])</span><br><span class="line">            B.append(<span class="string">'-'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            A.append(<span class="string">'-'</span>)</span><br><span class="line">            B.append(S2[j])</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Print info about new DNA sequences with minimum number of mismatches.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    A.reverse()</span><br><span class="line">    B.reverse()</span><br><span class="line">    printA, printB = <span class="string">''</span>,<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(A)):</span><br><span class="line">        printA += A[i]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(B)):</span><br><span class="line">        printB += B[i]</span><br><span class="line">    print(<span class="string">'New S1 is:   '</span>+ printA)</span><br><span class="line">    print(<span class="string">'New S2 is:   '</span>+ printB)</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Calculate the number of mismatches.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    mismatch = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(A)):</span><br><span class="line">        <span class="keyword">if</span> A[i] != B[i] <span class="keyword">or</span> (A[i] == <span class="string">'-'</span> <span class="keyword">and</span> B[i] == <span class="string">'-'</span>):</span><br><span class="line">            mismatch += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> mismatch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    S1 = list(<span class="string">"GGATCGA"</span>)</span><br><span class="line">    S2 = list(<span class="string">"GAATTCAGTTA"</span>)</span><br><span class="line">    print(MinMismatch(S1,S2))</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ohyoukillkenny.github.io/blog/blog/2018/01/08/micro-payment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lingkun Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lingkun's Small House">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/01/08/micro-payment/" itemprop="url">
                  Micropayment
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-08T10:11:52+08:00">2018-01-08</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Learn-Solidity/" itemprop="url" rel="index"><span itemprop="name">Learn Solidity</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Smart-Contract-Micropayment"><a href="#Smart-Contract-Micropayment" class="headerlink" title="Smart Contract: Micropayment"></a>Smart Contract: Micropayment</h3><p><strong>作者</strong>：孔令坤，<strong>转载请注明出处</strong></p>
<p>在Solidity的官网上，<strong>Micropayment Channel</strong>的例子目前暂待开发。于是我决定自己写一个Micropayment的合约。</p>
<h4 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h4><p>什么是Micropayment?</p>
<p>假设你是一个中国移动用户，正在拨打国际长途电话，然后中国移动会根据你的通话时长来进行收费，每分钟1元钱，并按照满分钟计算（比如打了2分钟20秒，记为3分钟）。这个时候，我们可以通过一个智能合约，进行你与中国移动之间的付款。显然，如果你每分钟都要给中国移动付钱，那么这样就太麻烦了，相当于你每打一分钟电话就要再掏出一分钟的话费。这个时候，我们可以用所谓的Micropayment，来进行一次性的费用支付。</p>
<img src="/blog/2018/01/08/micro-payment/1.png" title="Overview of Micropayment">
<p>如上图所示，Alice 通过智能合约向Bob（服务提供者）进行支付。首先，Alice往合约里存100单位的钱，然后获得Bob提供的服务。此后，智能合约开始计算时长。当Alice停止服务后，他将调用合约的函数，进行服务的停止。然后合约会自动结算Bob的服务费，然后将存在合约里的钱分别给到Alice和Bob手里。</p>
<p>同时，为了防止Alice一直不停止服务，Bob拿不到应该拿到的服务费用，我们应当在合约中提供让Bob终止合约，并拿到所有的钱的选项。这个选项的判定条件应当是Alice已经用完了所有服务的时长。</p>
<h4 id="Code-1："><a href="#Code-1：" class="headerlink" title="Code 1："></a>Code 1：</h4><p>以下是第一段代码，需要注意的是这里我在code中并没有像传统的Micropayment Channel一样使用multi-sig。但是事实上，由于remix特殊的编程环境，user需要在service provider发起的合约的地址下<code>At Address</code>进行<code>startService</code>函数的使用。因此，其实从某种一样上，这个合约里也存在着用户与服务提供方对协议的共识。此代码remix亲测可用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.11</span>;</span><br><span class="line"></span><br><span class="line">contract Micropayment&#123;</span><br><span class="line">    uint public value;</span><br><span class="line">    uint public feePerMinute; <span class="comment">// the fee is counted by wei</span></span><br><span class="line">    uint public startTime;</span><br><span class="line">    uint public endTime;</span><br><span class="line">    address public serviceProvider;</span><br><span class="line">    address public user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Micropayment</span>(<span class="params">uint fee</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(fee &gt; <span class="number">0</span>);</span><br><span class="line">        serviceProvider = msg.sender;</span><br><span class="line">        feePerMinute = fee;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier condition(bool _condition) &#123;</span><br><span class="line">        <span class="built_in">require</span>(_condition);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyProvider() &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == serviceProvider);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyUser() &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.sender == user);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event ServiceStarted();</span><br><span class="line">    event ServiceEnded();</span><br><span class="line">    event ForceEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Force end the Micropayment (the service provider),</span></span><br><span class="line">    <span class="comment">/// and get paid,</span></span><br><span class="line">    <span class="comment">/// when user has run out his time.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">forcePay</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyProvider</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(now &gt;= endTime);</span><br><span class="line">        ForceEnd();</span><br><span class="line">        serviceProvider.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Start service as user.</span></span><br><span class="line">    <span class="comment">/// Give a expected service time.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">startService</span>(<span class="params">uint eT</span>) // <span class="title">minutes</span></span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">condition</span>(<span class="params">msg.value &gt;= feePerMinute * eT</span>)</span></span><br><span class="line"><span class="function">        <span class="title">payable</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ServiceStarted();</span><br><span class="line">        user = msg.sender;</span><br><span class="line">        startTime = now;</span><br><span class="line">        endTime = now + eT * <span class="number">1</span> minutes;</span><br><span class="line">        value = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// End the service (the user).</span></span><br><span class="line">    <span class="comment">/// Pay bill to service provider according to using time.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">endService</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        <span class="title">public</span></span></span><br><span class="line"><span class="function">        <span class="title">onlyUser</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(now &lt; endTime);</span><br><span class="line">        uint usingTime = (now - startTime) / <span class="number">60</span> + <span class="number">1</span>;</span><br><span class="line">        uint bill = usingTime * feePerMinute;</span><br><span class="line">        user.transfer(value - bill);</span><br><span class="line">        serviceProvider.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">        ServiceEnded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以在我的github中找到：<a href="https://github.com/Ohyoukillkenny/Learn-Solidity" target="_blank" rel="noopener">https://github.com/Ohyoukillkenny/Learn-Solidity</a></p>
<h4 id="Potential-Improvement"><a href="#Potential-Improvement" class="headerlink" title="Potential Improvement"></a>Potential Improvement</h4><p>目前的micropayment合约有一个比较伤的缺点，就是无法防止service的提供者, i.e., 中国移动耍赖。比如线下的时候明明还没有到服务截止时间，就停止了服务。从合约的角度来讲，目前无法杜绝这种情况的发生。所以和之前的<a href="https://ohyoukillkenny.github.io/blog/01/03/LearnSolidity3/">remote purchase</a>合约一样，需要线下有第三方的监管。</p>
<h4 id="Code-2"><a href="#Code-2" class="headerlink" title="Code 2:"></a>Code 2:</h4><p>在与他人的交流中，有一位大佬觉得Code 1中的合约其实不是传统意义上的Micropayment Channel，所以这里我又写了一段代码，加入了传统的multi-sig，使得合约更加贴近通常意义上的Micropayment Channel。</p>
<p>这里我假设Bob, i.e., <code>worker</code>是给Alice, i.e., <code>moneyProvider</code>干活的人。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.11</span>;</span><br><span class="line"></span><br><span class="line">contract Channel &#123;</span><br><span class="line"></span><br><span class="line">    address public moneyProvider;</span><br><span class="line">    address public worker;</span><br><span class="line">    uint public startTime;</span><br><span class="line">    uint public timeOut;</span><br><span class="line">    mapping (<span class="function"><span class="params">bytes32</span> =&gt;</span> address) signatures;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Channel</span>(<span class="params">address to, uint t</span>) <span class="title">payable</span> </span>&#123;</span><br><span class="line">        worker = to;</span><br><span class="line">        moneyProvider = msg.sender;</span><br><span class="line">        startTime = now;</span><br><span class="line">        timeOut = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// this function can be both called by moneyProvider and worker,</span></span><br><span class="line">    <span class="comment">// we use sha3 as hash function in this case.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CloseChannel</span>(<span class="params">bytes32 h, uint8 v, bytes32 r, bytes32 s, uint value</span>)</span>&#123;</span><br><span class="line">        address signer;</span><br><span class="line">        bytes32 proof;</span><br><span class="line">        <span class="comment">// get signer from signature</span></span><br><span class="line">        signer = ecrecover(h, v, r, s);</span><br><span class="line">        <span class="comment">// signature is invalid, throw</span></span><br><span class="line">        <span class="built_in">require</span> (signer == moneyProvider || signer == worker);</span><br><span class="line">        proof = sha3(<span class="keyword">this</span>, value);</span><br><span class="line">        <span class="comment">// signature also needs to match the data provided</span></span><br><span class="line">        <span class="built_in">require</span> (proof == h);</span><br><span class="line">        <span class="keyword">if</span> (signatures[proof] == <span class="number">0</span>)</span><br><span class="line">            signatures[proof] = signer;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (signatures[proof] != signer)&#123;</span><br><span class="line">            <span class="comment">// channel completed, both signatures provided</span></span><br><span class="line">            worker.transfer(value);</span><br><span class="line">            selfdestruct(moneyProvider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// this function is called by moneyProvider, when worker is malicious.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">moneyBack</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">require</span> (startTime + timeOut &gt; now &amp;&amp; msg.sender == moneyProvider);</span><br><span class="line">        selfdestruct(moneyProvider);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总体而言，传统的写法对后端执行的要求更多，需要涉及哈希和签名的处理，另外支付的金额也是在后台进行计算的。此外由于有比较长的数据包要被smart contract多次处理，所以会消耗相对而言多得多的gas。</p>
<p>另外在code 2的逻辑中，同样无法避免的是moneyProvider耍赖的情况，因为最后是由moneyProvider决定最后给worker发多少钱, i.e., <code>value</code>，假如moneyProvider发的钱和之前说好的不一样，合约也无法对其进行制裁。所以我们仍然需要第三方进行监管。但是由于应当支付的钱不断被worker用<code>closeChannel</code>函数作为transaction写到block里面去，所以相对而言，最后moneyProvider要发多少是被记录下来的，是有迹可循的。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ohyoukillkenny.github.io/blog/blog/2018/01/07/null-in-solidity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lingkun Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lingkun's Small House">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/01/07/null-in-solidity/" itemprop="url">
                  NULL in Solidity
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-07T15:47:08+08:00">2018-01-07</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Learn-Solidity/" itemprop="url" rel="index"><span itemprop="name">Learn Solidity</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Inexistent-NULL-in-Solidity"><a href="#Inexistent-NULL-in-Solidity" class="headerlink" title="Inexistent NULL in Solidity"></a>Inexistent NULL in Solidity</h3><p><strong>作者</strong>：孔令坤，<strong>转载请注明出处</strong></p>
<p>在Solidity中，并没有Null值的存在。所有的变量在初始化后都会被默认为0值。这导致我们在写代码的时候需要多加注意。</p>
<p>比如<a href="https://ohyoukillkenny.github.io/blog/01/03/LearnSolidity3/">之前</a>我遇到的<code>enum</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enum State &#123; Created, Locked, Inactive &#125;</span><br><span class="line"><span class="comment">// Created = 0, Locked = 1, Inactive = 2</span></span><br></pre></td></tr></table></figure>
<p>之后，代码在没有对<code>myState</code>变量进行赋值的情况下，直接判断：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(myState == Created.Created);</span><br></pre></td></tr></table></figure>
<p>所以这个时系统断定判断通过，而且并不会报错。</p>
<p>那么，如何判断<code>mapping</code>中是否某个键是否”为空”呢？</p>
<p>比较标准的做法是建立一个专门和value相关的结构体，用一个布尔型变量来看是否这个key所对应的value被赋过值，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">library Library &#123;</span><br><span class="line">  struct data &#123;</span><br><span class="line">     uint val;</span><br><span class="line">     bool isValue;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">contract myContract&#123;</span><br><span class="line">    using Library <span class="keyword">for</span> Library.data;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> Library.data) cluster;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ifExist</span>(<span class="params">address id</span>) <span class="title">returns</span>(<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cluster[id].isValue) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> flase; </span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="function"><span class="keyword">function</span> <span class="title">addCluster</span>(<span class="params">address id</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cluster[id].isValue) <span class="keyword">throw</span>; <span class="comment">// duplicate key</span></span><br><span class="line">        <span class="comment">// add ...</span></span><br><span class="line">      	cluster[id].isValue = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，我们也可以简单的来看一下value所对应的length来判断这个值是否被赋值过（零值无法判断！）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public deposits;</span><br><span class="line"><span class="keyword">if</span>(deposits[msg.sender].length == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// deposit[msg.sender] is empty, do your thing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们不用判断某个变量是否为赋过值后的零值时，我建议用第二种通过length来判断的方法，因为后者将大大减少合约gas的消耗。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ohyoukillkenny.github.io/blog/blog/2018/01/04/start-solidity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lingkun Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lingkun's Small House">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/01/04/start-solidity/" itemprop="url">
                  Start with Solidity
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-04T20:26:02+08:00">2018-01-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Learn-Solidity/" itemprop="url" rel="index"><span itemprop="name">Learn Solidity</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Ethereum-and-Solidity环境配置"><a href="#Ethereum-and-Solidity环境配置" class="headerlink" title="Ethereum and Solidity环境配置"></a>Ethereum and Solidity环境配置</h2><p><strong>作者</strong>：孔令坤，<strong>转载请注明出处</strong></p>
<p>由于Remix版本的更新，Metamask的更新已经Ethereum rinkeby network对Github账号申请eth的限制，我发现原来的<a href="https://karl.tech/learning-solidity-part-1-deploy-a-contract/" target="_blank" rel="noopener">配置教程</a>其实并不太适用于当前的版本了，所以在这里我简单的介绍一下开发的一些基本配置。在接下来的配置内容中，我借鉴了许多来自<a href="http://www.initc3.org/events/2017-07-13-IC3-Ethereum-Crypto-Boot-Camp-at-Cornell-University.html" target="_blank" rel="noopener">IC3 Ethereum/Cornell Bootcamp</a>的内容，主要对其中Github部分的内容做了更新。</p>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements:"></a>Requirements:</h3><ul>
<li><a href="https://www.google.com/chrome/index.html" target="_blank" rel="noopener">Google Chrome</a></li>
<li><a href="https://twitter.com/" target="_blank" rel="noopener">Twitter Account</a></li>
<li><a href="https://metamask.io/" target="_blank" rel="noopener">Metamask</a></li>
</ul>
<h3 id="Introduction-of-Things"><a href="#Introduction-of-Things" class="headerlink" title="Introduction of Things:"></a>Introduction of Things:</h3><h4 id="Ethereum"><a href="#Ethereum" class="headerlink" title="Ethereum"></a><a href="http://ethdocs.org/en/latest/" target="_blank" rel="noopener">Ethereum</a></h4><p>Ethereum is an open-source, public, blockchain-based distributed computing platform featuring smart contract (scripting) functionality.</p>
<h4 id="Metamask"><a href="#Metamask" class="headerlink" title="Metamask"></a><a href="https://metamask.io/" target="_blank" rel="noopener">Metamask</a></h4><p>MetaMask is a bridge between Google Chrome and the Ethereum blockchain. It allows you to run Ethereum Dapps in your browser without running a full Ethereum node. MetaMask includes a secure identity vault, providing a user interface to manage your identities on different sites and sign blockchain transactions.</p>
<h4 id="Solidity"><a href="#Solidity" class="headerlink" title="Solidity"></a><a href="https://solidity.readthedocs.io/en/latest/" target="_blank" rel="noopener">Solidity</a></h4><p>Solidity is a programming language used to code smart contracts that are compatible with Ethereum. <a href="https://solidity.readthedocs.io/en/latest/" target="_blank" rel="noopener">The documentation for Solidity is located here</a>. We will be using <a href="https://ethereum.github.io/browser-solidity/" target="_blank" rel="noopener">Remix</a> when developing our smart contracts. Remix is an online development environment that allows you to code, deploy, and test smart contracts on the public Ethereum networks and test Ethereum networks.</p>
<h4 id="Rinkeby"><a href="#Rinkeby" class="headerlink" title="Rinkeby"></a><a href="https://www.rinkeby.io/" target="_blank" rel="noopener">Rinkeby</a></h4><p>Rinkeby is a public Ethereum test network that is used to deploy and test smart contracts for free. In order to receive Rinkeby ether coins, you will need to visit <a href="https://www.rinkeby.io/" target="_blank" rel="noopener">https://www.rinkeby.io/</a> once you have your Metamask client installed.</p>
<h3 id="Start-with-Ethereum-and-Solidity"><a href="#Start-with-Ethereum-and-Solidity" class="headerlink" title="Start with Ethereum and Solidity:"></a>Start with Ethereum and Solidity:</h3><p><strong>a. Setting up Metamask</strong></p>
<ol>
<li>Install the <a href="https://metamask.io/" target="_blank" rel="noopener">Metamask Chrome plugin</a>.</li>
<li>Open Metamask (there should be an orange fox icon in your browser toolbar).</li>
<li>Click through the license agreements.</li>
<li>Create a new “den” which will house your Ethereum account.</li>
<li>COPY THE 12 WORDS SOMEWHERE SAFE.</li>
<li>Click the network selection button on the top left part of the Metmask app. It should say “Ethereum Mainnet” or “Ropsten”. Change that to Rinkeby.</li>
<li>Copy your Ethereum account address by clicking the “Copy” icon above the “Buy” and “Send” buttons. Mouse over the icons to reveal their label.</li>
</ol>
<p><strong>b. Get Rinkeby Testnet Ether</strong></p>
<ol>
<li>Login into your <a href="https://twitter.com/" target="_blank" rel="noopener">Twitter account</a>.</li>
<li>Paste your Ethereum address you copied in step a.7 into the “What’s happening?” content boxs to make a new tweet. The Ethereum address should be a jumble of letters and numbers like this: <code>0x9bcd107A7De7C3cee1be15dFa06B5586672912e9</code></li>
<li>Click “Tweet” to gennerate a new Tweet.</li>
<li>Copy the URL of the Tweet. Click the button in the upper right of your tweet and select the option of “Copy link to Tweet”. The link should be similar to this:<code>https://twitter.com/316980786Kong/status/946989538890588161</code></li>
<li>Visit the <a href="https://www.rinkeby.io/" target="_blank" rel="noopener">Rinkeby website</a> and click “Crypto Faucet”.</li>
<li>Paste your Tweet URL in the box provided and click “Give me Ether - 3 ethers/8 hours”.</li>
<li>A box should pop up with with your Twitter icon indicating that your request for testnet ether is being processed.</li>
<li>Wait 10 seconds.</li>
<li>Look at your Metamask client and verify that you received 3 Rinkeby testnet ether.</li>
</ol>
<p><strong>c. Writing your first smart contract.</strong></p>
<ol>
<li>Go to the <a href="https://karl.tech/learning-solidity-part-2-voting/" target="_blank" rel="noopener">Learning Solidity Part 2: Commit-Reveal Voting</a>.</li>
<li>Walk through the blog and write your first smart contract.</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ohyoukillkenny.github.io/blog/blog/2018/01/03/LearnSolidity3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lingkun Kong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lingkun's Small House">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/01/03/LearnSolidity3/" itemprop="url">
                  Learn Solidity (3) — Safe Remote Purchase
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-03T13:17:07+08:00">2018-01-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Learn-Solidity/" itemprop="url" rel="index"><span itemprop="name">Learn Solidity</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Solidity学习笔记-3-—-Safe-Remote-Purchase"><a href="#Solidity学习笔记-3-—-Safe-Remote-Purchase" class="headerlink" title="Solidity学习笔记(3) — Safe Remote Purchase"></a>Solidity学习笔记(3) — Safe Remote Purchase</h3><p><strong>作者</strong>：孔令坤，<strong>转载请注明出处</strong></p>
<p>今天用拍卖合约（Safe Remote Purchase）进行Smart Contract编程的学习。</p>
<p>今天的这一段代码，有一些比较tricky的地方，所以我的笔记也会比较详细。</p>
<p>附上官方的学习代码链接：<a href="https://solidity.readthedocs.io/en/latest/solidity-by-example.html#safe-remote-purchase" target="_blank" rel="noopener">https://solidity.readthedocs.io/en/latest/solidity-by-example.html#safe-remote-purchase</a></p>
<p>另外发现了一个不错的大纲型文档：<a href="https://medium.com/@mattcondon/getting-up-to-speed-on-ethereum-63ed28821bbe" target="_blank" rel="noopener">https://medium.com/@mattcondon/getting-up-to-speed-on-ethereum-63ed28821bbe</a></p>
<h4 id="1-功能简介"><a href="#1-功能简介" class="headerlink" title="1.功能简介"></a>1.功能简介</h4><p>这个合约作为一个第三方的平台，用于远程购买一个商品时暂存买方付的钱，然后在买方确认交易后将钱付给商家。整体而言这个合约相当于我们用淘宝网购时的淘宝平台，用户购买时将钱先付给淘宝平台，然后商家发货。用户在收到商品后在淘宝上确认付款，这时淘宝会把钱打给商户。</p>
<p>在使用这个合约时，卖方需要先自己创建(create)合约。整个流程与下图类似：</p>
<img src="/blog/2018/01/03/LearnSolidity3/overview.png" title="Overview of Safe Remote Purchase Contract">
<h4 id="2-代码简介"><a href="#2-代码简介" class="headerlink" title="2.代码简介"></a>2.代码简介</h4><p><strong>初始函数</strong>：首先，我们看建立合约的初始函数，根据函数中的<code>payable</code>，说明这里发起协议的seller需要在transaction里面放价格为商品两倍的保证金。这里是整个合约最tricky的地方，即seller放了商品价格两倍的保证金。这样有两个目的，其一可以防止黑心商家，发起协议后不给用户发货，用户在确认后白白损失金额。其二可以让买方积极的去确认收到商品了，因为买方也要交商品价格两倍的保证金，如果不确认收到商品，他们将白白损失钱财。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enum State &#123; Created, Locked, Inactive &#125;</span><br><span class="line">State public state;</span><br><span class="line"><span class="comment">// 这一段用require代码确认seller的value是偶数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Purchase</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    seller = msg.sender;</span><br><span class="line">    value = msg.value / <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">require</span>((<span class="number">2</span> * value) == msg.value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这么写有浪费gas的问题。因为如果不是偶数，之前的语句已经执行过了，<code>require</code>导致函数回退时将会消耗更多的gas。所以我觉得这一段可以改成：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Purchase</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    seller = msg.sender;</span><br><span class="line">    <span class="built_in">require</span>((msg.value % <span class="number">2</span>) == <span class="number">0</span>);</span><br><span class="line">    value = msg.value / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外神奇的是，在创建合约的函数里面，合约并没有写<code>state = State.Created;</code>然而在下面的<code>abort()</code>函数中，<code>inState(State.Created)</code>的判定竟然通过了。经过代码调试，我发现在<code>State public state;</code>这句话的时候，虽然没有直接赋值，但是系统默认state的值为空，在做<code>==</code>判定的时候，默认<code>state = 0</code>了。总之之后编程需要多多小心。PS. 我这里在调试的时候，加了一个<code>enum State { Created, Locked, Inactive }</code>然后创建了一个2eth的合约。于是我永久的丢掉了2eth。</p>
<p><strong>终止合约：</strong>在终止函数里，我想提一下<code>transfer</code>和<code>send</code>函数的区别。两者都是像地址传递钱，区别在于如果<code>transfer</code>函数运行失败，系统会throw一个错误，而<code>send</code>函数则会返回一个<code>false</code>的布尔值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abort</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">onlySeller</span></span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Created</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Aborted();</span><br><span class="line">    state = State.Inactive;</span><br><span class="line">  	<span class="comment">// 这里把seller的保证金还给seller，里面应该是2V - gas fee</span></span><br><span class="line">    seller.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>确认支付：</strong> 这个函数由buyer在seller发起的协议基础上访问，会在协议里存两倍商品价格的钱，存完后会将Contract的状态标记为锁定, i,e., <code>Locked</code>。至于为何要付两倍的钱，我认为可能是因为这个协议担心用户会懒得确认到货，所以这么做来使得用户自己能够被</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">confirmPurchase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Created</span>)</span></span><br><span class="line"><span class="function">    <span class="title">condition</span>(<span class="params">msg.value == (<span class="number">2</span> * value</span>))</span></span><br><span class="line"><span class="function">    <span class="title">payable</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PurchaseConfirmed();</span><br><span class="line">    buyer = msg.sender;</span><br><span class="line">    state = State.Locked;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>确认收货：</strong> 这个函数由buyer在seller发起的协议基础上访问，buyer确认收到商品，这样之后协议会把钱退回给buyer和seller。需要注意的是，这里官方代码认为所有的交易费用应该由seller承担。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">confirmReceived</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span></span></span><br><span class="line"><span class="function">    <span class="title">onlyBuyer</span></span></span><br><span class="line"><span class="function">    <span class="title">inState</span>(<span class="params">State.Locked</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ItemReceived();</span><br><span class="line">    <span class="comment">// It is important to change the state first because</span></span><br><span class="line">    <span class="comment">// otherwise, the contracts called using `send` below</span></span><br><span class="line">    <span class="comment">// can call in again here.</span></span><br><span class="line">    state = State.Inactive;</span><br><span class="line">	<span class="comment">// 返回用户多余的押金，一倍商品价格</span></span><br><span class="line">    buyer.transfer(value);</span><br><span class="line">    <span class="comment">// 把剩下的 3V - gas fee的钱给商家。</span></span><br><span class="line">    seller.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-一些思考"><a href="#3-一些思考" class="headerlink" title="3.一些思考"></a>3.一些思考</h4><p>在看代码的过程中，我发现这个合约有一个无法解决的问题。</p>
<p>假如有一些恶意的用户想搞垮商家，于是买了商品后就是不确认，这样用户通过损失等价于一个商品价格的费用（因为用户其实收到了商品），就可以坑掉商家三倍商品价格的钱（商家发出了商品）。</p>
<p>其实这个问题的本质源于smart contract无法监管商品的运转，即它无法发现假如钱被锁死在了合约里面，是谁干了坏事。所以我觉得就remote purchace这个问题而言，比较理想的状况还是得有一个买卖双方都信的过的第三方机构介入其中。buyer先把钱寄给这个第三方机构，然后由第三方机构作为仲裁方，决定把钱最终交给buyer还是seller。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><a class="extend next" rel="next" href="/blog/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lingkun Kong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/blog/archives/">
                
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lingkun Kong</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=6.1.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
